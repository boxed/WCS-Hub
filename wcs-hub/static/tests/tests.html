<!DOCTYPE html>
<html ng-app="WCSHub">
    <head>
        <meta charset="utf-8">
        <title>WCS-Hub Tests</title>
        <script src="doctestjs/doctest.js"></script>
        <link href="doctestjs/doctest.css" rel="stylesheet"/>

        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.0.2/angular.min.js"></script>
        <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.1/jquery-ui.min.js"></script>
        <script src="/static/angular-ui.min.js"></script>
        <script src="/static/wcs.js"></script>
        <script>
            function TestCtrl($injector) {
                window.$injector = $injector;
            }

            function new_scope() {
                return window.$injector.get('$rootScope').$new();
            }

            function create_controller(controller, params) {
                var scope = new_scope();
                var $controller = window.$injector.get('$controller');
                if (!params) {
                    params = {};
                }
                params.$scope = scope;
                $controller(controller, params);
                return scope;
            }

            var today = new Date();
            var tomorrow = new Date(today.getTime() + 24 * 60 * 60 * 1000);
            var yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);

            var get_url_done = false;
            var get_url_result = '';
            function get_url(url, method, data) {
                get_url_done = false;
                get_url_result = '';

                if (!method) {
                    method = 'GET';
                }
                window.$injector.get('$http')({
                    method: method,
                    url: url,
                    data: data}).
                    success(
                        function(data, status, headers, config) {
                            get_url_done = true;
                            get_url_result = data;
                        }).
                    error(
                        function(data, status, headers, config) {
                            get_url_done = true;
                            get_url_result = status + data;
                        });
                wait(function(){return get_url_done;});
            }
        </script>
    </head>
    <body class="autodoctest" ng-controller="TestCtrl">

<h1>Reset DB</h1>
<pre class="commenttest">
get_url('/ajax/reset_db/', 'POST');
</pre>

<pre class="commenttest">
print(get_url_result);
// => ok
</pre>


<h1>MenuCtrl</h1>
<pre class="commenttest">
var scope = create_controller(MenuCtrl);
print(scope.getClass('/foo'));
// =>
print(scope.getClass(window.$injector.get('$location').path()));
// => current
</pre>

<h1>CreateEventCtrl</h1>
<pre class="commenttest">
var scope = create_controller(CreateEventCtrl);
scope.event.competitions['J&J'][4].show = true;
print(scope.ok_to_save())
// => false
scope.event.name = 'name test';
print(scope.ok_to_save())
// => true
scope.event.description = 'description test';
scope.event.date = today;
scope.event.registration_opens = yesterday;
scope.event.registration_closes = tomorrow;
scope.save()

get_url('/ajax/list_events/?__get__all__=');
// =>
</pre>

<pre class="commenttest">
var event_id = angular.fromJson(get_url_result)['events'][0].id;
print(get_url_result);
/* =>
{
  events: [
    {
      competitions: {
        "J&J": [
          ...
          {name: "Allstar", show: true, value: false},
          ...
        ],
        ...
      },
      ...
      description: "description test",
      id: "?",
      name: "name test",
      ...
    }
  ],
  ...
}
*/
</pre>

<h1>EditEventCtrl</h1>
<pre class="commenttest">
var scope = create_controller(EditEventCtrl, {$routeParams: {eventId: event_id}});
wait(function(){return scope.event || scope.error;});
</pre>

<pre class="commenttest">
print(scope.error)
// => undefined
scope.event.competitions['J&J'][2].show = true;
scope.event.name = 'name test2';
scope.event.description = 'description test2';
print(scope.ok_to_save())
// => true
scope.save()

get_url('/ajax/list_events/?__get__all__=');
wait(function(){return get_url_done;});
</pre>

<pre class="commenttest">
print(get_url_result);
/* =>
{
  events: [
    {
      competitions: {
        "J&J": [
          ...
          {name: "Intermediate", show: true, value: false},
          ...
          {name: "Allstar", show: true, value: false},
          ...
        ],
        ...
      },
      ...
      description: "description test2",
      id: "?",
      name: "name test2",
      ...
    }
  ],
  ...
}
*/
</pre>

<h1>ListEventsCtrl</h1>
<pre class="commenttest">
var scope2 = create_controller(ListEventsCtrl);
wait(function(){return scope2.events || scope2.error;});
</pre>

<pre class="commenttest">
print(scope2.error)
// => undefined
print(scope2.events.length)
// => 1
print(scope2.events[0].name)
// => name test2
</pre>

<h1>SignUpCtrl</h1>
<pre class="commenttest">
var scope = create_controller(SignUpCtrl, {$routeParams: {eventId: event_id}});
wait(function(){return scope.event || scope.error;});
</pre>

<pre class="commenttest">
print(scope.error)
// => undefined
print(scope.ok_to_register());
// => false
scope.first_name = 'Anders';
scope.last_name = 'Hovmöller';
scope.lead_follow = 'lead';
scope.event.competitions['J&J'][2].value = true;
print(scope.ok_to_register());
// => true
scope.register();
wait(function(){return scope.registration_complete || scope.error;});
</pre>

<pre class="commenttest">
print(scope.first_name)
// =>
print(scope.error)
// => undefined
scope.register_another();
wait(function(){return scope.event || scope.error;});
</pre>

<pre class="commenttest">
scope.first_name = 'Mârïá';
scope.last_name = 'ÅnnöyingUnicode';
scope.lead_follow = 'follow';
scope.event.competitions['J&J'][1].value = true;
print(scope.ok_to_register());
// => true
scope.register();
wait(function(){return scope.registration_complete || scope.error;});
</pre>

<pre class="commenttest">
print(scope.error)
// => undefined
</pre>

<h1>RegistrationsCtrl</h1>
<pre class="commenttest">
var scope = create_controller(RegistrationsCtrl, {$routeParams: {eventId: event_id}});
wait(function(){return scope.event || scope.error;});
</pre>

<pre class="commenttest">
print(scope.error)
// => undefined
print(scope.has_registrations());
// => true
print(scope.comps);
/* => {
  "J&J Intermediate": [
    {
      first_name: "Anders",
      last_name: "Hovmöller",
      lead_follow: "lead",
      user: ...
    }
  ],
  "J&J Novice": [
    {
      first_name: "Mârïá",
      last_name: "ÅnnöyingUnicode",
      lead_follow: "follow",
      user: ...
    }
  ]
}
*/
</pre>


<h1>FinalsCtrl</h1>
<pre class="commenttest">
</pre>

    </body>
</html>